{% load static %}

<div class="stock-alerts-container">
  {# Alertas con dise√±o tem√°tico de dulces #}
  <div class="alerts-position-fixed">
    {# Alerta de stock bajo - Dise√±o dulce #}
    <div id="stock-warning-alert" class="alert alert-warning alert-dismissible fade show visually-hidden" role="alert" 
         style="max-width: 400px; border: 3px solid var(--amarillo-dulce); background-color: rgba(255, 255, 255, 0.95); 
                border-radius: 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.15);">
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      <h4 class="alert-heading" style="font-family: 'Luckiest Guy', cursive; color: var(--morado-dulce);">üç¨ ¬°Dulces por agotarse!</h4>
      <div id="stock-warning-content" style="color: #555;">
        {# Contenido din√°mico #}
      </div>
      <div class="mt-2 text-center">
        <img src="{% static 'images/candy-icon.png' %}" width="40" class="me-2">
        <img src="{% static 'images/candy-icon.png' %}" width="30" class="me-2">
        <img src="{% static 'images/candy-icon.png' %}" width="20">
      </div>
    </div>

    {# Alerta predictiva - Dise√±o dulce cr√≠tico #}
    <div id="stock-prediction-alert" class="alert alert-danger alert-dismissible fade show visually-hidden" role="alert" 
         style="max-width: 400px; border: 3px solid var(--rosa-dulce); background-color: rgba(255, 255, 255, 0.95); 
                border-radius: 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.15);">
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      <h4 class="alert-heading" style="font-family: 'Luckiest Guy', cursive; color: var(--rosa-dulce);">üö® ¬°Emergencia de dulces!</h4>
      <div id="stock-prediction-content" style="color: #555;">
        {# Contenido din√°mico #}
      </div>
      <div class="mt-2 text-center">
        <img src="{% static 'images/emergency-candy.png' %}" width="40">
      </div>
    </div>
  </div>

  {# Badge flotante con estilo de dulce #}
  <div id="stock-alert-badge" class="position-fixed top-0 end-0 m-3 visually-hidden" style="z-index: 1000;">
    <span class="badge rounded-pill p-2 stock-alert-pulse" 
          style="background: linear-gradient(90deg, var(--rosa-dulce), var(--morado-dulce)); 
                 font-family: 'Poppins', sans-serif; font-weight: 600; font-size: 1rem;">
      üç≠ <span id="stock-alert-count">0</span> dulces necesitan atenci√≥n
    </span>
  </div>
</div>

<style>
  /* Estilos tem√°ticos para dulces */
  .alerts-position-fixed {
    position: fixed;
    bottom: 80px;  /* Ajustado para no solapar con el reproductor */
    right: 20px;
    z-index: 1050;
    display: flex;
    flex-direction: column;
    gap: 15px;
  }
  
  .stock-alert-pulse {
    animation: pulseWarning 2s infinite;
    cursor: pointer;
    color: white;
    font-weight: 600;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    border: 2px solid white;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    transition: all 0.3s;
  }
  
  .stock-alert-pulse:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 15px rgba(0,0,0,0.2);
  }
  
  @keyframes pulseWarning {
    0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 155, 179, 0.7); }
    70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(255, 155, 179, 0); }
    100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 155, 179, 0); }
  }
  
  .dulce-with-alert {
    background-color: rgba(255, 209, 102, 0.2) !important;
    border-left: 4px solid var(--amarillo-dulce) !important;
    transition: all 0.3s ease;
    position: relative;
  }
  
  .dulce-with-alert::after {
    content: 'üç¨';
    position: absolute;
    left: -25px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 1.2rem;
  }
  
  .dulce-with-critical-alert {
    background-color: rgba(255, 155, 179, 0.2) !important;
    border-left: 4px solid var(--rosa-dulce) !important;
    position: relative;
    animation: criticalPulse 1.5s infinite;
  }
  
  .dulce-with-critical-alert::after {
    content: "üö®";
    position: absolute;
    left: -25px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 1.2rem;
  }
  
  @keyframes criticalPulse {
    0% { box-shadow: 0 0 0 0 rgba(255, 155, 179, 0.4); }
    70% { box-shadow: 0 0 0 8px rgba(255, 155, 179, 0); }
    100% { box-shadow: 0 0 0 0 rgba(255, 155, 179, 0); }
  }
</style>

<script>
  // Funci√≥n para mostrar alertas de dulces
  function showStockAlerts(lowStockDulces, criticalStockDulces) {
    // Mostrar badge en el navbar
    const totalAlerts = lowStockDulces.length + criticalStockDulces.length;
    if (totalAlerts > 0) {
      const badge = document.getElementById('stock-alert-badge');
      badge.classList.remove('visually-hidden');
      document.getElementById('stock-alert-count').textContent = totalAlerts;
      
      // Efecto de vibraci√≥n para llamar la atenci√≥n
      badge.style.animation = 'shake 0.5s';
      setTimeout(() => { badge.style.animation = ''; }, 500);
      
      badge.addEventListener('click', function() {
        showAllAlerts(lowStockDulces, criticalStockDulces);
      });
    }
    
    // Mostrar alertas cr√≠ticas inmediatamente
    if (criticalStockDulces.length > 0) {
      showCriticalAlerts(criticalStockDulces);
    }
    
    // Resaltar dulces en tablas
    highlightDulcesInTables(lowStockDulces, criticalStockDulces);
  }
  
  // Funci√≥n para mostrar todas las alertas
  function showAllAlerts(lowStockDulces, criticalStockDulces) {
    if (lowStockDulces.length > 0) {
      showWarningAlerts(lowStockDulces);
    }
    if (criticalStockDulces.length > 0) {
      showCriticalAlerts(criticalStockDulces);
    }
  }
  
  // Funci√≥n para mostrar alertas de advertencia
  function showWarningAlerts(dulces) {
    const alert = document.getElementById('stock-warning-alert');
    const content = document.getElementById('stock-warning-content');
    
    content.innerHTML = `
      <p style="margin-bottom: 10px;">¬°Estos dulces est√°n bajos en stock!</p>
      <ul class="mb-2" style="padding-left: 20px;">
        ${dulces.map(d => `
          <li style="margin-bottom: 8px;">
            <strong style="color: var(--morado-dulce);">${d.nombre}</strong><br>
            <span style="color: var(--amarillo-dulce);">üç¨ ${d.cantidad} unidades restantes</span> | 
            ${d.dias_restantes ? `‚è≥ ~${d.dias_restantes} d√≠as para agotarse` : 'M√≠nimo: ' + d.stock_minimo}
          </li>
        `).join('')}
      </ul>
      <hr style="border-color: var(--amarillo-dulce);">
      <p class="mb-0"><a href="/dulce" class="alert-link" style="color: var(--morado-dulce); font-weight: 600;">Ver inventario de dulces</a></p>
    `;
    
    alert.classList.remove('visually-hidden');
    
    // Cerrar autom√°ticamente despu√©s de 15 segundos
    setTimeout(() => {
      const bsAlert = new bootstrap.Alert(alert);
      bsAlert.close();
    }, 15000);
  }
  
  // Funci√≥n para mostrar alertas cr√≠ticas
  function showCriticalAlerts(dulces) {
    const alert = document.getElementById('stock-prediction-alert');
    const content = document.getElementById('stock-prediction-content');
    
    content.innerHTML = `
      <p style="margin-bottom: 10px;">¬°Estos dulces est√°n cr√≠ticamente bajos!</p>
      <ul class="mb-2" style="padding-left: 20px;">
        ${dulces.map(d => `
          <li style="margin-bottom: 8px;">
            <strong style="color: var(--rosa-dulce);">${d.nombre}</strong><br>
            <span style="color: #dc3545;">üç¨ ${d.cantidad} unidades restantes</span> | 
            ${d.dias_restantes ? `‚è≥ ~${d.dias_restantes} d√≠as para agotarse` : 'M√≠nimo: ' + d.stock_minimo}
          </li>
        `).join('')}
      </ul>
      <hr style="border-color: var(--rosa-dulce);">
      <p class="mb-0"><a href="/dulce" class="alert-link" style="color: var(--rosa-dulce); font-weight: 600;">Ver inventario de dulces</a></p>
    `;
    
    alert.classList.remove('visually-hidden');
    
    // Cerrar autom√°ticamente despu√©s de 15 segundos
    setTimeout(() => {
      const bsAlert = new bootstrap.Alert(alert);
      bsAlert.close();
    }, 15000);
  }
  
  // Funci√≥n para resaltar dulces en tablas
  function highlightDulcesInTables(lowStockDulces, criticalStockDulces) {
    document.querySelectorAll('.dulce-row').forEach(row => {
      const dulceId = row.dataset.dulceId;
      const isLowStock = lowStockDulces.some(d => d.id == dulceId);
      const isCritical = criticalStockDulces.some(d => d.id == dulceId);
      
      if (isCritical) {
        row.classList.add('dulce-with-critical-alert');
      } else if (isLowStock) {
        row.classList.add('dulce-with-alert');
      }
    });
  }
  
  // Animaci√≥n de shake para el badge
  document.head.insertAdjacentHTML('beforeend', `
    <style>
      @keyframes shake {
        0% { transform: translateX(0) rotate(0deg); }
        25% { transform: translateX(-5px) rotate(-5deg); }
        50% { transform: translateX(5px) rotate(5deg); }
        75% { transform: translateX(-5px) rotate(-5deg); }
        100% { transform: translateX(0) rotate(0deg); }
      }
      
      .alert-link {
        transition: all 0.3s;
        text-decoration: none;
      }
      
      .alert-link:hover {
        text-decoration: underline;
        transform: translateX(5px);
      }
    </style>
  `);
</script>